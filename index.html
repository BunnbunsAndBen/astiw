<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>ASTiW</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="dark.css" id="themer">
	<script src="script.js"></script>
	<script>
		var lastid = 1;
		var topp;
		
		function addRecent(item, b) {
			var i = item.indexOf(':');
			var splits = [item.slice(0, i), item.slice(i + 1)];
			var main = document.getElementById('main');
			var el = document.createElement('a');
			el.href = 'post.html?id=' + splits[0];
			el.className = 'recentLinks';
			if (b) {
				el.innerHTML = '<div class="recent bb"><b>' + splits[1].replace(/</g, '&lt;').replace(/>/g, '&gt;') +'</b></div>'
			} else {
				el.innerHTML = '<div class="recent"><b>' + splits[1].replace(/</g, '&lt;').replace(/>/g, '&gt;') +'</b></div>'
			}
			main.appendChild(el);
			lastid = splits[0];
		};
		
		function load() {
			var jsonurl = 'https://api.stibarc.gq/getposts.sjs';
			var r = new XMLHttpRequest();
			r.addEventListener('load', function() {
				var stuf = r.responseText.split("\n");
				topp = r.responseText.split(':')[0];
				stuf.splice(stuf.length - 1, 1);
				document.getElementById('rm').removeChild(document.getElementById('loader'));
				for (i = 0; i < stuf.length; i++) {
					addRecent(stuf[i], i == 0);
				}
				document.getElementById('loadmore').style.display = 'initial';
				if (!(localStorage.getItem('astiw_roi') == 'true')) {
					setTimeout(checkNewPosts, 500);
				}
			});
			r.addEventListener('error', function() {alert('Please connect to the internet and reload the page')});
			r.open('get', jsonurl, true);
			r.send();
		};
		
		function loadMore() {
			document.getElementById('loadmore').style.display = 'none';
			var ldr = document.createElement('div');
			ldr.className = 'loader';
			ldr.id = 'loader';
			document.getElementById('rm').appendChild(ldr);
			var jsonurl = 'https://api.stibarc.gq/getposts.sjs?id=' + lastid;
			var r = new XMLHttpRequest();
			r.addEventListener('load', function() {
				var stuf = r.responseText.split("\n");
				stuf.splice(stuf.length - 1, 1);
				document.getElementById('rm').removeChild(document.getElementById('loader'));
				for (i = 0; i < stuf.length; i++) {
					addRecent(stuf[i], false);
				}
				document.getElementById('loadmore').style.display = 'initial';
			});
			r.addEventListener('error', function() {alert('Please connect to the internet and reload the page')});
			r.open('get', jsonurl, true);
			r.send();
		};
		
		function checkNewPosts() {
			var jsonurl = 'https://api.stibarc.gq/getposts.sjs';
			var r = new XMLHttpRequest();
			r.addEventListener('load', function() {
				var thingy = r.responseText.split(':')[0];
				if (Number(thingy) > Number(topp)) {
					document.getElementById('refreshMarker').style.display = 'block';
				} else {
					setTimeout(checkNewPosts, 500);
				}
			});
			r.addEventListener('error', function() {});
			r.open('get', jsonurl, true);
			r.send();
		};
	</script>
</head>
<body>
	<nav><a id="title" href="index.html">ASTiW</a><input type="search" id="search" class="txf" placeholder="Search"><a href="newpost.html" class="mi ib">+</a><a href="settings.html" class="mi">&#8943;</a><a href="javascript:openUserMenu();" id="usermenu" class="mi ib rightmost"></a><a href="register.html" class="lb" id="register">REGISTER</a><a href="login.html" class="lb rightmost">LOG IN</a></nav>
	<div id="refreshMarker" onclick="window.location.reload();">&#8635; Reload to see new post(s)</div>
	<div id="cssshade"></div>
	<div class="dbg" id="usermenubox">
		<div class="dialog">
			<a href="javascript:closeUserMenu();" class="closeButton">&times;</a>
			<h3 id="currentUserName"></h3>
			<div style="margin-top:16px;"><a class="othbut" id="userMenuProfButton" style="margin-right:8px;">View profile</a><a class="othbut" href="editprofile.html">Edit profile</a></div>
			<p style="margin:8px 0;"><a class="classic" href="changepassword.html">Change password</a></p>
			<p style="margin:8px 0;"><a class="classic" href="mailto:herronjo110@gmail.com?subject=STiBaRC%20User%20Verification%20Request">Request user verification</a></p>
			<hr style="margin:20px 0;">
			<div id="accountSwitcher" style="display:none;">
				<h4 style="margin-top:20px;">Switch account</h4>
				<ul style="padding:0 0 0 20px;" id="accounts">
				</ul>
				<hr style="margin:20px 0;">
			</div>
			<div style="margin-top:16px;"><a class="othbut" href="login.html" style="margin-right:8px;">Add account</a><a class="othbut" href="logout.html">Log out</a></div>
			<p style="margin:8px 0;"><a class="classic" href="register.html">Register a new account</a></p>
		</div>
	</div>
	<main id="rm">
		<div id="main"></div>
		<button id="loadmore" class="tkob" onclick="loadMore();">LOAD MORE</button>
		<div class="loader" id="loader"></div>
	</main>
</body>
</html>