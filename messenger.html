<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Messenger - ASTiW</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="themes/dark.css" id="themer">
	<script src="aes.js"></script>
	<script src="script.js"></script>
	<script>
		var sesses;
		var mySess;
		var oldresp = '';
		var myName;
		var hfb;
		var currentChat;
		var currentLength;
		var highlightChat;
		var repeaterLoadingChat;
		var queue = [];
		var otherPerson;
		var okToClose = true;
		var okToCloseCM = true;
		var newId;
		var newName;
		var oldDate;
		var noPreviews;
		var newChatDialog;
		var encryptionDialog;
		var chatOptionsDialog;
		var sortDialog;
		var mostRecentTime;
		var doPinning = true;
		var doHiding = true;
		var encryptionKey;
		var doEncr = false;
		
		function load() {
			sesses = localStorage.getItem('astiw_sesses');
			myName = getCurrentUser();
			if (isSet(sesses) && JSON.parse(sesses).length > 0 && myName != 'Anon') {} else {
				window.location.replace('login.html');
			}
			mySess = JSON.parse(sesses)[0];
			document.getElementById('messages').onscroll = function(e) {
				var msgBox = document.getElementById('messages');
				if (msgBox.scrollTop == 0 && hfb > 0) {
					var msgs = generateMsgs(oldresp, hfb);
					var oldSH = msgBox.scrollHeight;
					msgBox.innerHTML = msgs + msgBox.innerHTML;
					msgBox.scrollTop = msgBox.scrollHeight - oldSH;
				}
				if (msgBox.scrollTop >= msgBox.scrollHeight - msgBox.offsetHeight - 16) {
					document.getElementById('toBottom').style.display = 'none';
				} else {
					document.getElementById('toBottom').style.display = '';
				}
			};
			newChatDialog = document.getElementById('newChatDialog');
			chatOptionsDialog = document.getElementById('chatOptions');
			sortDialog = document.getElementById('sorter');
			encryptionDialog = document.getElementById('encryptionDialog');
			window.addEventListener('click', function(e) {
				if (e.target == newChatDialog) {
					closeNCD();
				}
				if (e.target == chatOptionsDialog) {
					closeCO();
				}
				if (e.target == sortDialog) {
					closeSD();
				}
				if (e.target == encryptionDialog) {
					closeED();
				}
			});
			document.getElementById('messageBox').addEventListener('keydown', function(e) {
				if (e.keyCode == 13 && !e.shiftKey) {
					e.preventDefault();
					submitMessage();
				}
			});
			document.getElementById('newUsername').addEventListener('keydown', function(e) {
				if (e.keyCode == 13 && document.getElementById('startChat').style.display != 'none') {
					start();
				}
			});
			document.getElementById('encryptionBox').addEventListener('keydown', function(e) {
				if (e.keyCode == 13) {
					saveEncryption();
				}
			});
			window.addEventListener('keydown', function(e) {
				if (e.keyCode == 27) {
					closeNCD();
					closeCO();
					closeSD();
					closeED();
				}
			});
			noPreviews = localStorage.getItem('astiw_showpreviews') == 'true';
			oldDate = new Date().getDate();
			var jsonurl = 'https://messenger.stibarc.gq/api/v2/getuserchats.sjs';
			var r = new XMLHttpRequest();
			r.addEventListener('load', function() {
				var ok = true;
				try {
					var parsed = JSON.parse(r.responseText);
				} catch (err) {
					ok = false;
				}
				if (ok) {
					putChats(parsed);
					document.getElementById('rm').removeChild(document.getElementById('loader'));
					document.getElementById('hidden').style.display = '';
					if (sessHasChanged()) {
						document.getElementById('cssshade').style.display = '';
						setTimeout(sayToReload, 500);
					} else {
						setTimeout(repeater, 500);
					}
				} else {
					r.open('post', jsonurl, true);
					r.send('sess=' + mySess);
				}
			});
			r.addEventListener('error', function() {alert('Could not connect to STiBaRC, please reload the page and try again')});
			r.open('post', jsonurl, true);
			r.send('sess=' + mySess);
		};
		
		function putChats(tmp) {
			var main = document.getElementById('main');
			var chatslist = [];
			var favslist = [];
			var doFavs = doPinning;
			var doHide = doHiding;
			if (!doFavs || !doHide) {
				document.getElementById('sortLink').style.color = 'var(--red)';
			} else {
				document.getElementById('sortLink').style.color = '';
			}
			var hidValue;
			var blocksValue = localStorage.getItem('astiw_blocks');
			var blocksArr = (isSet(blocksValue) ? JSON.parse(blocksValue) : [])
			for (key in tmp) {
				hidValue = localStorage.getItem('astiw_hidechat' + key);
				if (tmp[key].user != myName && tmp[key].user != 'Anon' && blocksArr.indexOf(tmp[key].user) == -1 && (!doHide || (isSet(tmp[key].lastmessage) && isSet(tmp[key].lastmessage.time) && tmp[key].lastmessage.time != 'unknown' ? tmp[key].lastmessage.time : 0) >= (isSet(hidValue) ? Number(hidValue) : 0))) {
					if (doFavs && localStorage.getItem('astiw_pinchat' + key) == 'true') {
						favslist.push([key, tmp[key], true]);
					} else {
						chatslist.push([key, tmp[key], false]);
					}
				}
			}
			favslist.sort(function(a, b) {return (isSet(b[1].lastmessage) && isSet(b[1].lastmessage.time) && b[1].lastmessage.time != 'unknown' ? b[1].lastmessage.time : 0) - (isSet(a[1].lastmessage) && isSet(a[1].lastmessage.time) && a[1].lastmessage.time != 'unknown' ? a[1].lastmessage.time : 0);});
			chatslist.sort(function(a, b) {return (isSet(b[1].lastmessage) && isSet(b[1].lastmessage.time) && b[1].lastmessage.time != 'unknown' ? b[1].lastmessage.time : 0) - (isSet(a[1].lastmessage) && isSet(a[1].lastmessage.time) && a[1].lastmessage.time != 'unknown' ? a[1].lastmessage.time : 0);});
			chatslist = favslist.concat(chatslist);
			var elInside;
			var els = '';
			var msgId;
			var msgDetail;
			if (favslist.length > 0) {
				els += '<div class="recent nosides small" style="background-color:var(--content-bg); margin:0;">Pinned</div>'
			}
			for (eg = 0; eg < chatslist.length; eg++) {
				if (favslist.length > 0 && eg == favslist.length) {
					els += '<div class="recent nosides small" style="background-color:var(--content-bg); margin:0;">Other</div>'
				}
				msgId = chatslist[eg][0];
				msgDetail = chatslist[eg][1];
				elInside = '<div id="chatItem' + msgId + '" class="recent nosides' + (msgId == highlightChat ? ' selectedChatItem' : '') + '"><b>' + msgDetail.user.replace(/</g, '&lt;').replace(/>/g, '&gt;') +'</b>' + (isSet(msgDetail.lastmessage) && isSet(msgDetail.lastmessage.time) && msgDetail.lastmessage.time != 'unknown' ? '<span style="float:right; margin:3.5px 0 0 0;" class="small">' + generateTS(msgDetail.lastmessage.time, 0) + '</span>' : '') + (isSet(msgDetail.lastmessage) ? '<p class="small" style="margin-bottom:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + (msgDetail.lastmessage.sender == myName ? '&#x2197;&#xFE0E;' : '&#x2199;&#xFE0E;') + ' ' + (msgDetail.lastmessage.message.indexOf('[Encrypted] ') == 0 && msgDetail.lastmessage.message.length > 12 ? '[Encrypted message]' : msgDetail.lastmessage.message.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br/>') + '</p>') : '') + '</div>';
				els += '<a href="javascript:openChat(' + msgId + ', \'' + msgDetail.user.replace(/'/g, '\\\'') + '\', false)" class="recentLinks">' + elInside + '</a>';
			}
			main.innerHTML = els;
		};
		
		function generateTS(millis, type) {
			var d = new Date(millis);
			var now = new Date();
			if (type == 2 & d.getFullYear() == now.getFullYear() && d.getMonth() == now.getMonth() && d.getDate() == now.getDate()) {
				return 'Today';
			} else if (type != 1 && isYesterday(d, now)) {
				return 'Yesterday';
			} else if (type != 1 && d.getFullYear() != now.getFullYear()) {
				return d.getFullYear().toString() + '-' + r2d(d.getMonth() + 1) + '-' + r2d(d.getDate());
			} else if (type == 2 || (type != 1 && d.getDate() != now.getDate())) {
				var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
				return monthNames[d.getMonth()] + ' ' + r2d(d.getDate());
			} else {
				var pm = false;
				var hours = d.getHours();
				if (hours == 0) {
					hours = 12;
				} else if (hours == 12) {
					pm = true;
				} else if (hours > 12) {
					hours = hours - 12;
					pm = true;
				}
				return hours.toString() + ':' + r2d(d.getMinutes()) + ' ' + (pm ? 'PM' : 'AM');
			}
		};
		
		function isLeap(year) {
			return new Date(year, 1, 29).getDate() === 29;
		};
		
		function isYesterday(d, now) {
			var ans = false;
			var finalDays = [31, (isLeap(d.getFullYear()) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
			if (d.getFullYear() == now.getFullYear() && d.getMonth() == now.getMonth() && d.getDate() == now.getDate() - 1) {
				ans = true;
			} else if (now.getDate() == 1 && d.getFullYear() == now.getFullYear() && d.getMonth() == now.getMonth() - 1 && d.getDate() == finalDays[d.getMonth()]) {
				ans = true;
			} else if (d.getFullYear() == now.getFullYear() - 1 && d.getMonth() == 11 && d.getDate() == 31) {
				ans = true;
			}
			return ans;
		}
		
		function r2d(inp) {
			var inpStr = inp.toString();
			return (inp < 10 ? '0' + inpStr : inpStr);
		};
		
		function closeChat() {
			if (isSet(currentChat) && isSet(document.getElementById('chatItem' + currentChat))) {
				document.getElementById('chatItem' + currentChat).className = 'recent nosides';
			}
			currentChat = undefined;
			encryptionKey = undefined;
			highlightChat = undefined;
			mostRecentTime = undefined;
			document.getElementById('theChat').style.display = 'none';
			document.getElementById('noChat').style.display = '';
			oldresp = undefined;
			otherPerson = undefined;
			document.getElementById('chatPersonUsername').innerHTML = '';
			document.getElementById('chatPersonUsername').href = '';
			document.getElementById('messages').innerHTML = '';
		};
		
		function openChat(chatid, thePerson, override) {
			if (currentChat != 'processing' && (currentChat != chatid || override)) {
				if (isSet(currentChat)) {
					document.getElementById('chatItem' + currentChat).className = 'recent nosides';
				}
				currentChat = 'processing';
				document.getElementById('theChat').style.display = 'none';
				document.getElementById('noChat').style.display = 'none';
				var ldr = document.createElement('div');
				ldr.className = 'loader';
				ldr.style.margin = 'auto';
				ldr.id = 'loader2';
				document.getElementById('rightSide').appendChild(ldr);
				document.getElementById('chatItem' + chatid).className = 'recent selectedChatItem nosides';
				highlightChat = chatid;
				var jsonurli = 'https://messenger.stibarc.gq/api/v2/getuserchat.sjs';
				var ri = new XMLHttpRequest();
				ri.addEventListener('load', function() {
					var ok = true;
					try {
						var parsed = JSON.parse(ri.responseText);
					} catch (err) {
						ok = false;
					}
					if (ok) {
						oldresp = ri.responseText;
						encryptionKey = localStorage.getItem('astiw_encryptkey' + chatid);
						doEncr = isSet(encryptionKey);
						if (doEncr) {
							document.getElementById('encryptionMarker').style.display = '';
							document.getElementById('encryptionMarker').style.color = 'var(--verified)';
						} else {
							document.getElementById('encryptionMarker').style.display = 'none';
							document.getElementById('encryptionMarker').style.color = 'var(--border)';
						}
						var msgs = generateMsgs(ri.responseText, 'start');
						document.getElementById('chatPersonUsername').innerHTML = thePerson.replace(/</g, '&lt;').replace(/>/g, '&gt;');
						otherPerson = thePerson;
						document.getElementById('chatPersonUsername').href = 'user.html?id=' + encodeURIComponent(thePerson);
						var msgBox = document.getElementById('messages');
						msgBox.innerHTML = msgs + '<button id="toBottom" style="display:none;" onclick="scrollToBottom();">&#x2913;</button>';
						document.getElementById('rightSide').removeChild(document.getElementById('loader2'));
						document.getElementById('theChat').style.display = '';
						msgBox.scrollTop = msgBox.scrollHeight;
						currentChat = chatid;
						var te = document.getElementById('messageBox');
						var saved = localStorage.getItem('astiw_savedmsg' + chatid);
						if (isSet(saved)) {
							te.value = saved;
						} else {
							te.value = '';
						}
						te.focus();
					} else {
						ri.open('post', jsonurli, true);
						ri.send('sess=' + mySess + '&id=' + chatid);
					}
				});
				ri.addEventListener('error', function() {alert('Could not connect to STiBaRC, please reload the page and try again')});
				ri.open('post', jsonurli, true);
				ri.send('sess=' + mySess + '&id=' + chatid);
			}
		};
		
		function scrollToBottom() {
			var msgBox = document.getElementById('messages');
			msgBox.scrollTop = msgBox.scrollHeight;
		};
		
		function generateMsgs(resp, inputind) {
			var ok = true;
			try {
				var tmp = JSON.parse(resp);
			} catch (err) {
				ok = false;
			}
			if (ok) {
				if (Object.keys(tmp).length == 0) {
					currentLength = 0;
					return '';
				}
				var msgs = '';
				var itsMe;
				var currentMessage;
				var encryptionStatus = 0;
				var readyForTime = false;
				var oldTime = new Date(0);
				var newTime;
				if (inputind == 'start') {
					var ind = Object.keys(tmp).length;
					currentLength = ind;
				} else {
					var ind = inputind;
					readyForTime = true;
					oldTime = (tmp[ind + 1].time == 'unknown' ? 'unknown' : new Date(tmp[ind + 1].time));
				}
				hfb = ind - 20;
				while (ind > hfb && isSet(tmp[ind - 1])) {
					ind--;
					itsMe = tmp[ind].sender == myName;
					newTime = (tmp[ind].time == 'unknown' ? 'unknown' : new Date(tmp[ind].time));
					if (readyForTime && (newTime == 'unknown' ? oldTime != 'unknown' : newTime.getDate() != oldTime.getDate() || newTime.getMonth() != oldTime.getMonth() || newTime.getFullYear() != oldTime.getFullYear())) {
						msgs = '<p class="small" style="margin:16px 0; text-align:center;">' + generateTS(oldTime, 2) + '</p>' + msgs;
					}
					readyForTime = true;
					oldTime = newTime;
					if (tmp[ind].message.indexOf('[Encrypted] ') == 0 && tmp[ind].message.length > 12) {
						if (isSet(encryptionKey)) {
							currentMessage = decryptStr(tmp[ind].message.substring(12), encryptionKey);
							if (currentMessage == '') {
								currentMessage = '[Encrypted message]';
								encryptionStatus = 2;
							} else {
								encryptionStatus = 1;
							}
						} else {
							currentMessage = '[Encrypted message]';
							encryptionStatus = 2;
						}
					} else {
						currentMessage = tmp[ind].message;
						encryptionStatus = 0;
					}
					msgs = '<div style="margin:16px; text-align:' + (itsMe ? 'right' : 'left') + ';"><div class="small" style="margin:0 2px 4px 2px; vertical-align:bottom;">' + (isSet(tmp[ind].time) && tmp[ind].time != 'unknown' ? generateTS(tmp[ind].time, 1) : '') + (encryptionStatus > 0 ? ' <span style="color:var(--verified);">&#x1f512;&#xfe0e;</span>' : '') + '</div><div ' + (itsMe ? 'class="specialty" ' : '') + 'style="max-width:calc(100% - 39px); display:inline-block; word-wrap:break-word; ' + (encryptionStatus == 2 ? 'color:var(--red)' : 'padding:8px 18.5px; border-radius:18.5px; border:1px solid var(--border); ' + (itsMe ? 'background-color:var(--link); color:var(--opposing);' : 'background-color:var(--content-bg);')) + '">' + putLinksInText(currentMessage.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br/>')) + '</div>' + insertImage(currentMessage) + '</div>' + msgs;
					if (ind == Object.keys(tmp).length - 1 && inputind == 'start') {
						mostRecentTime = (isSet(tmp[ind].time) && tmp[ind].time != 'unknown' ? tmp[ind].time : 0);
					}
				}
				if (oldTime != 'unknown' && !isSet(tmp[ind - 1])) {
					msgs = '<p class="small" style="margin:16px 0; text-align:center;">' + generateTS(oldTime, 2) + '</p>' + msgs;
				}
				return msgs;
			} else {
				return 'if you see this please report it';
			}
		};
		
		function repeater() {
			var jsonurl = 'https://messenger.stibarc.gq/api/v2/getuserchats.sjs';
			var jsonurli = 'https://messenger.stibarc.gq/api/v2/getuserchat.sjs';
			var r = new XMLHttpRequest();
			var ri = new XMLHttpRequest();
			r.addEventListener('load', function() {
				var ok = true;
				try {
					var parsed = JSON.parse(r.responseText);
				} catch (err) {
					ok = false;
				}
				if (ok) {
					putChats(parsed);
					if (!okToCloseCM) {
						okToCloseCM = true;
						if (!isSet(document.getElementById('chatItem' + currentChat))) {
							closeChat();
						}
						closeCO();
						closeSD();
					}
					if (isSet(newId)) {
						document.getElementById('bad').style.display = '';
						document.getElementById('same').style.display = '';
						document.getElementById('newUsername').disabled = false;
						document.getElementById('newClose').style.cursor = 'pointer';
						okToClose = true;
						document.getElementById('contain').removeChild(document.getElementById('loader3'));
						document.getElementById('startChat').style.display = '';
						newChatDialog.style.display = 'none';
						openChat(newId, newName, false);
						newId = undefined;
						newName = undefined;
					}
					var newDate = new Date().getDate();
					if (isSet(currentChat) && currentChat != 'processing') {
						if (newDate != oldDate) {
							openChat(currentChat, otherPerson, true);
						} else {
							repeaterLoadingChat = currentChat;
							ri.send('sess=' + mySess + '&id=' + repeaterLoadingChat);
						}
					} else {
						if (sessHasChanged()) {
							document.getElementById('cssshade').style.display = '';
							sayToReload();
						} else {
							setTimeout(repeater, 500);
						}
					}
					oldDate = newDate;
				} else {
					if (sessHasChanged()) {
						document.getElementById('cssshade').style.display = '';
						sayToReload();
					} else {
						setTimeout(repeater, 500);
					}
				}
			});
			ri.addEventListener('load', function() {
				if (repeaterLoadingChat == currentChat) {
					var ok = true;
					try {
						var tmp = JSON.parse(ri.responseText);
					} catch (err) {
						ok = false;
					}
					if (ok) {
						if (Object.keys(tmp).length > currentLength) {
							var msgs = '';
							var itsMe;
							var readyForTime = false;
							var newTime;
							var ind = currentLength;
							var alomftop = false;
							var alomfm = false;
							currentLength = Object.keys(tmp).length;
							if (isSet(tmp[ind - 1])) {
								var oldTime = new Date(tmp[ind - 1].time);
							} else {
								var oldTime = new Date(0);
							}
							while (ind < Object.keys(tmp).length) {	
								itsMe = tmp[ind].sender == myName;
								if (itsMe) {
									alomfm = true;
								} else {
									alomftop = true;
								}
								newTime = new Date(tmp[ind].time)
								if (newTime.getDate() != oldTime.getDate() || newTime.getMonth() != oldTime.getMonth() || newTime.getFullYear() != oldTime.getFullYear()) {
									msgs += '<p class="small" style="margin:16px 0; text-align:center;">' + generateTS(newTime, 2) + '</p>';
								}
								oldTime = newTime;
								if (tmp[ind].message.indexOf('[Encrypted] ') == 0 && tmp[ind].message.length > 12) {
									if (isSet(encryptionKey)) {
										currentMessage = decryptStr(tmp[ind].message.substring(12), encryptionKey);
										if (currentMessage == '') {
											currentMessage = '[Encrypted message]';
											encryptionStatus = 2;
										} else {
											encryptionStatus = 1;
										}
									} else {
										currentMessage = '[Encrypted message]';
										encryptionStatus = 2;
									}
								} else {
									currentMessage = tmp[ind].message;
									encryptionStatus = 0;
								}
								msgs += '<div style="margin:16px; text-align:' + (itsMe ? 'right' : 'left') + ';"><div class="small" style="margin:0 2px 4px 2px; vertical-align:bottom;">' + (isSet(tmp[ind].time) && tmp[ind].time != 'unknown' ? generateTS(tmp[ind].time, 1) : '') + (encryptionStatus > 0 ? ' <span style="color:var(--verified);">&#x1f512;&#xfe0e;</span>' : '') + '</div><div ' + (itsMe ? 'class="specialty" ' : '') + 'style="max-width:calc(100% - 39px); display:inline-block; word-wrap:break-word; ' + (encryptionStatus == 2 ? 'color:var(--red)' : 'padding:8px 18.5px; border-radius:18.5px; border:1px solid var(--border); ' + (itsMe ? 'background-color:var(--link); color:var(--opposing);' : 'background-color:var(--content-bg);')) + '">' + putLinksInText(currentMessage.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br/>')) + '</div>' + insertImage(currentMessage) + '</div>';
								mostRecentTime = (isSet(tmp[ind].time) && tmp[ind].time != 'unknown' ? tmp[ind].time : 0);
								ind++;
							}
							var msgBox = document.getElementById('messages');
							var stb = false;
							if (msgBox.scrollTop >= msgBox.scrollHeight - msgBox.offsetHeight - 16) {
								stb = true;
							}
							msgBox.innerHTML += msgs;
							if (stb || alomfm) {
								msgBox.scrollTop = msgBox.scrollHeight;
							}
							if (localStorage.getItem('astiw_messagesound') != 'true' && alomftop) {
								var msgTone = new Audio('res/new_message.wav');
								msgTone.play();
							}
						}
					}
				}
				if (sessHasChanged()) {
					document.getElementById('cssshade').style.display = '';
					sayToReload();
				} else {
					setTimeout(repeater, 500);
				}
			});
			r.addEventListener('error', function() {
				if (sessHasChanged()) {
					document.getElementById('cssshade').style.display = '';
					sayToReload();
				} else {
					setTimeout(repeater, 500);
				}
			});
			ri.addEventListener('error', function() {
				if (sessHasChanged()) {
					document.getElementById('cssshade').style.display = '';
					sayToReload();
				} else {
					setTimeout(repeater, 500);
				}
			});
			r.open('post', jsonurl, true);
			ri.open('post', jsonurli, true);
			r.send('sess=' + mySess);
		};
		
		function submitMessage() {
			var message = document.getElementById('messageBox').value;
			document.getElementById('messageBox').value = '';
			if (isSet(message)) {
				saveMessage();
				if (isSet(encryptionKey) && doEncr) {
					message = '[Encrypted] ' + encryptStr(message, encryptionKey);
				}
				var jsonurl = 'https://messenger.stibarc.gq/api/postchat.sjs';
				var r = new XMLHttpRequest();
				r.addEventListener('load', function() {
					if (localStorage.getItem('astiw_sendsound') != 'true') {
						var sendTone = new Audio('res/send_message.wav');
						sendTone.play();
					}
				});
				r.addEventListener('error', function() {alert('Could not connect to STiBaRC, please reload the page and try again')});
				r.open('post', jsonurl, true);
				r.send('sess=' + mySess + '&other=' + otherPerson + '&id=' + currentChat + '&message=' + encodeURIComponent(message));
			}
		};
		
		function newChat() {
			document.getElementById('newUsername').value = '';
			document.getElementById('bad').style.display = 'none';
			document.getElementById('same').style.display = 'none';
			newChatDialog.style.display = 'initial';
			document.getElementById('newUsername').focus();
		};
		
		function closeNCD() {
			if (okToClose) {
				newChatDialog.style.display = 'none';
			}
		};
		
		function closeCO() {
			if (okToCloseCM) {
				chatOptionsDialog.style.display = 'none';
			}
		};
		
		function closeSD() {
			if (okToCloseCM) {
				sortDialog.style.display = 'none';
			}
		};
		
		function closeED() {
			encryptionDialog.style.display = 'none';
		};
		
		function chatMenu() {
			var pinned = localStorage.getItem('astiw_pinchat' + currentChat) == 'true';
			var hidValue = localStorage.getItem('astiw_hidechat' + currentChat);
			var hid = mostRecentTime < (isSet(hidValue) ? Number(hidValue) : 0);
			var blocksValue = localStorage.getItem('astiw_blocks');
			var blocked = isSet(blocksValue) && JSON.parse(blocksValue).indexOf(otherPerson) >= 0;
			var pinner = document.getElementById('pinner');
			var hider = document.getElementById('hider');
			var blocker = document.getElementById('blocker');
			pinner.getElementsByTagName('b')[0].innerHTML = (pinned ? 'Unpin chat' : 'Pin chat');
			pinner.parentElement.href = (pinned ? 'javascript:setPin(\'false\');' : 'javascript:setPin(\'true\');');
			hider.getElementsByTagName('b')[0].innerHTML = (hid ? 'Unhide chat' : 'Hide chat');
			hider.parentElement.href = (hid ? 'javascript:setHide(false);' : 'javascript:setHide(true);');
			blocker.getElementsByTagName('b')[0].innerHTML = 'Block ' + otherPerson.replace(/</g, '&lt;').replace(/>/g, '&gt;');
			pinner.getElementsByTagName('p')[0].innerHTML = (pinned ? 'Stop displaying this chat above other chats in the list' : 'Display this chat above other chats in the list');
			hider.getElementsByTagName('p')[0].innerHTML = (hid ? 'Show this chat in the list' : 'Temporarily hide this chat from the list (until there is new activity)');
			pinner.style.backgroundColor = '';
			hider.style.backgroundColor = '';
			blocker.style.backgroundColor = '';
			chatOptionsDialog.style.display = 'initial';
		};
		
		function sortMenu() {
			var noHiding = document.getElementById('noHiding');
			var noPinning = document.getElementById('noPinning');
			noHiding.getElementsByTagName('b')[0].innerHTML = (doHiding ? 'Show hidden chats' : 'Hide hidden chats');
			noPinning.getElementsByTagName('b')[0].innerHTML = (doPinning ? 'Turn off pinning' : 'Turn on pinning');
			noHiding.style.backgroundColor = '';
			noPinning.style.backgroundColor = '';
			sortDialog.style.display = 'initial';
		};
		
		function togglePinning() {
			if (okToCloseCM) {
				doPinning = !doPinning;
				okToCloseCM = false;
				freezeSorterColor('noPinning');
			}
		};
		
		function toggleHiding() {
			if (okToCloseCM) {
				doHiding = !doHiding;
				okToCloseCM = false;
				freezeSorterColor('noHiding');
			}
		};
		
		function freezeColor(menuItem) {
			var pinner = document.getElementById('pinner');
			var hider = document.getElementById('hider');
			var blocker = document.getElementById('blocker');
			pinner.style.backgroundColor = (menuItem == 'pinner' ? 'var(--rollover)' : 'var(--content-bg)');
			hider.style.backgroundColor = (menuItem == 'hider' ? 'var(--rollover)' : 'var(--content-bg)');
			blocker.style.backgroundColor = (menuItem == 'blocker' ? 'var(--rollover)' : 'var(--content-bg)');
		};
		
		function freezeSorterColor(menuItem) {
			var noHiding = document.getElementById('noHiding');
			var noPinning = document.getElementById('noPinning');
			noPinning.style.backgroundColor = (menuItem == 'noPinning' ? 'var(--rollover)' : 'var(--content-bg)');
			noHiding.style.backgroundColor = (menuItem == 'noHiding' ? 'var(--rollover)' : 'var(--content-bg)');
		};
		
		function setPin(bool) {
			if (okToCloseCM) {
				localStorage.setItem('astiw_pinchat' + currentChat, bool);
				if (isSet(localStorage.getItem('astiw_hidechat' + currentChat))) {
					localStorage.setItem('astiw_hidechat' + currentChat, '0');
				}
				okToCloseCM = false;
				freezeColor('pinner');
			}
		};
		
		function setHide(bool) {
			if (okToCloseCM) {
				localStorage.setItem('astiw_hidechat' + currentChat, (bool ? new Date().getTime().toString() : '0'));
				if (localStorage.getItem('astiw_pinchat' + currentChat) == 'true') {
					localStorage.setItem('astiw_pinchat' + currentChat, 'false');
				}
				okToCloseCM = false;
				freezeColor('hider');
			}
		};
		
		function blockUser() {
			if (okToCloseCM) {
				if (confirm('Block this user? (go to settings to unblock users)')) {
					var blocksValue = localStorage.getItem('astiw_blocks');
					if (!isSet(blocksValue)) {
						blocksValue = '[]';
					}
					var blocksArr = JSON.parse(blocksValue);
					blocksArr.push(otherPerson);
					localStorage.setItem('astiw_blocks', JSON.stringify(blocksArr));
					okToCloseCM = false;
					freezeColor('blocker');
				}
			}
		};
		
		function setupEncryption() {
			if (okToCloseCM) {
				closeCO();
				document.getElementById('encryptionBox').value = encryptionKey;
				encryptionDialog.style.display = 'initial';
				document.getElementById('encryptionBox').focus();
			}
		};
		
		function saveEncryption() {
			localStorage.setItem('astiw_encryptkey' + currentChat, document.getElementById('encryptionBox').value);
			closeED();
			openChat(currentChat, otherPerson, true);
		};
		
		function start() {
			var theirs = document.getElementById('newUsername').value;
			if (isSet(theirs)) {
				document.getElementById('bad').style.display = 'none';
				document.getElementById('same').style.display = 'none';
				if (theirs != myName && theirs != 'Anon') {
					okToClose = false;
					document.getElementById('startChat').style.display = 'none';
					document.getElementById('newUsername').disabled = true;
					document.getElementById('newClose').style.cursor = 'not-allowed';
					var ldr = document.createElement('div');
					ldr.className = 'loader';
					ldr.id = 'loader3';
					ldr.style.margin = '0';
					document.getElementById('contain').appendChild(ldr);
					var jsonurl = 'https://messenger.stibarc.gq/api/newchat.sjs';
					var r = new XMLHttpRequest();
					r.addEventListener('load', function() {
						var tmp = r.responseText.split('\n');
						if (tmp[0] != 'bad') {
							newName = theirs;
							newId = Number(tmp[0]);
						} else {
							document.getElementById('bad').style.display = '';
							document.getElementById('newUsername').disabled = false;
							document.getElementById('newClose').style.cursor = 'pointer';
							okToClose = true;
							document.getElementById('contain').removeChild(document.getElementById('loader3'));
							document.getElementById('startChat').style.display = '';
							document.getElementById('newUsername').focus();
						}
					});
					r.addEventListener('error', function() {alert('Could not connect to STiBaRC, please reload the page and try again')});
					r.open('post', jsonurl, true);
					r.send('sess=' + mySess + '&user=' + theirs);
				} else {
					document.getElementById('same').style.display = '';
				}
			}
		};
		
		function saveMessage() {
			localStorage.setItem('astiw_savedmsg' + currentChat, document.getElementById('messageBox').value);
		};
		
		function insertImage(text) {
			if (!noPreviews && text.split(/( |\n)/g).length == 1 && (text.indexOf('http://') == 0 || text.indexOf('https://') == 0)) {
				if (text.toLowerCase().indexOf('.png') == text.length - 4 || text.toLowerCase().indexOf('.jpeg') == text.length - 5 || text.toLowerCase().indexOf('.jpg') == text.length - 4 || text.toLowerCase().indexOf('.gif') == text.length - 4 || text.toLowerCase().indexOf('.bmp') == text.length - 4) {
					return '<br/><a href="' + encodeURI(text) + '" target="_blank"><img src="' + text + '" class="msgImage"></a>';
				} else if (text.toLowerCase().indexOf('.mp3') == text.length - 4 || text.toLowerCase().indexOf('.wav') == text.length - 4 || text.toLowerCase().indexOf('.ogg') == text.length - 4) {
					var filetype = text.toLowerCase().substring(text.length - 3);
					return '<br/><audio controls style="margin-top:8px;"><source src="' + text + '" type="audio/' + (filetype == 'mp3' ? 'mpeg' : filetype) + '"></audio>';
				} else if (text.indexOf('https://www.youtube.com/watch') == 0) {
					var videoId = getAllUrlParams(text).v;
					return '<br/><a href="' + encodeURI(text) + '" target="_blank"><img src="https://img.youtube.com/vi/' + videoId + '/0.jpg" class="msgImage"></a>';
				} else if (text.indexOf('https://youtu.be/') == 0) {
					var videoId = text.substring(17);
					return '<br/><a href="' + encodeURI(text) + '" target="_blank"><img src="https://img.youtube.com/vi/' + videoId + '/0.jpg" class="msgImage"></a>';
				} else {
					return '';
				}
			} else {
				return '';
			}
		};
		
		function encryptStr(text, pass) {
			var encryptedAES = CryptoJS.AES.encrypt(text, pass);
			return encryptedAES.toString();
		};
		
		function decryptStr(text, pass) {
			try {
				var decryptedBytes = CryptoJS.AES.decrypt(text, pass);
				var plaintext = decryptedBytes.toString(CryptoJS.enc.Utf8);
			} catch (err) {
				var plaintext = '';
			}
			return plaintext;
		};
		
		function toggleEncrypt() {
			doEncr = !doEncr;
			if (doEncr) {
				document.getElementById('encryptionMarker').style.color = 'var(--verified)';
			} else {
				document.getElementById('encryptionMarker').style.color = 'var(--border)';
			}
		};
	</script>
</head>
<body style="overflow:hidden;">
	<nav><a id="title" href="index.html">ASTiW</a><input type="search" id="search" class="txf" placeholder="Search"><a href="messenger.html" id="messengerButton" class="mi ib noanon">&#x1f4ac;&#xfe0e;</a><a href="newpost.html" class="mi ib">+</a><a href="settings.html" class="mi">&#8943;</a><a href="javascript:openUserMenu();" id="usermenu" class="mi ib rightmost"></a><a href="register.html" class="lb" id="register">REGISTER</a><a href="login.html" class="lb rightmost">LOG IN</a></nav>
	<div id="cssshade"></div>
	<div class="dbg" id="usermenubox">
		<div class="dialog">
			<a href="javascript:closeUserMenu();" class="closeButton">&times;</a>
			<h3 id="currentUserName"></h3>
			<div style="margin-top:16px;"><a class="othbut" id="userMenuProfButton" style="margin-right:8px;">View profile</a><a class="othbut noanon" href="editprofile.html">Edit profile</a></div>
			<p style="margin:8px 0;"><a class="classic noanon" href="changepassword.html">Change password</a></p>
			<p style="margin:8px 0;"><a class="classic noanon" href="mailto:herronjo110@gmail.com?subject=STiBaRC%20User%20Verification%20Request">Request user verification</a></p>
			<hr style="margin:20px 0;">
			<div id="accountSwitcher" style="display:none;">
				<h4 style="margin-top:20px;">Switch account</h4>
				<ul style="padding:0 0 0 20px;" id="accounts">
				</ul>
				<hr style="margin:20px 0;">
			</div>
			<div style="margin-top:16px;"><a class="othbut" href="login.html" style="margin-right:8px;">Add account</a><a class="othbut" href="javascript:logoutCurrentUser();" id="lobut">Log out</a></div>
			<p style="margin:8px 0;"><a class="classic" href="register.html">Register a new account</a></p>
		</div>
	</div>
	<div class="dbg" id="newChatDialog">
		<div class="dialog">
			<a href="javascript:closeNCD();" id="newClose" class="closeButton">&times;</a>
			<h3>New chat</h3>
			<input type="text" spellcheck="false" id="newUsername" class="txf" placeholder="Enter username" style="display:block; width:calc(100% - 34px); margin-bottom:16px;">
			<div id="contain"><button id="startChat" onclick="start();" class="libut" style="display:block;">START</button></div>
			<p class="small" style="color:var(--red); display:none; margin:16px 0 0 0;" id="bad">User does not exist</p>
			<p class="small" style="color:var(--red); display:none; margin:16px 0 0 0;" id="same">Type another user's username</p>
		</div>
	</div>
	<div class="dbg" id="encryptionDialog">
		<div class="dialog">
			<a href="javascript:closeED();" class="closeButton">&times;</a>
			<h3>Set encryption key</h3>
			<p class="small">(Clear the field to disable encryption)</p>
			<input type="password" spellcheck="false" id="encryptionBox" class="txf" placeholder="Enter key" style="display:block; width:calc(100% - 34px); margin-bottom:16px;">
			<div id="contain"><button id="startChat" onclick="saveEncryption();" class="libut" style="display:block;">SAVE</button></div>
			<p>If the lock icon in the menu bar is green, outgoing messages will be encrypted</p>
		</div>
	</div>
	<div class="dbg" id="chatOptions">
		<div class="dialog" style="padding:0; border:0; width:30%;">
			<a class="recentLinks">
				<div class="recent bb" id="pinner">
					<b></b>
					<p class="small" style="margin-bottom:0;"></p>
				</div>
			</a>
			<a class="recentLinks">
				<div class="recent" id="hider">
					<b></b>
					<p class="small" style="margin-bottom:0;"></p>
				</div>
			</a>
			<a class="recentLinks" href="javascript:setupEncryption();">
				<div class="recent">
					<b>Set encryption key</b>
					<p class="small" style="margin-bottom:0;">Set a key for encryption/decryption of messages in this chat</p>
				</div>
			</a>
			<a class="recentLinks" href="javascript:blockUser();">
				<div class="recent" id="blocker">
					<b></b>
					<p class="small" style="margin-bottom:0;">Ignore chats between you and this user</p>
				</div>
			</a>
		</div>
	</div>
	<div class="dbg" id="sorter">
		<div class="dialog" style="padding:0; border:0; width:30%;">
			<a class="recentLinks" href="javascript:togglePinning();">
				<div class="recent bb" id="noPinning">
					<b></b>
				</div>
			</a>
			<a class="recentLinks" href="javascript:toggleHiding();">
				<div class="recent" id="noHiding">
					<b></b>
				</div>
			</a>
		</div>
	</div>
	<main id="rm" style="margin:0;">
		<div id="hidden" style="display:none;">
			<div style="position:absolute; width:30%; left:0; top:49px; bottom:0; border-right:1px solid var(--border); background-color:var(--content-bg);">
				<div style="height:22.5px; background-color:var(--content-bg); border-bottom: 1px solid var(--border); padding:8px;"><h3 style="margin:0; display:inline-block;">Messenger</h3><h3 style="margin:0; float:right; display:inline-block;"><a class="classic" href="javascript:newChat();">New</a><a style="margin-left:8px;" id="sortLink" class="classic" href="javascript:sortMenu();">&#x21c5;</a></h3></div>
				<div id="main" style="overflow:auto; height:calc(100vh - 88.5px);"></div>
			</div>
			<div id="rightSide" style="position:absolute; width:calc(70% - 1px); right:0; top:49px; bottom:0; display:flex; flex-direction:column;">
				<div id="noChat" style="margin:auto;">
					<div class="stdc" style="margin: 16px;"><p style="color:var(--border);">Select a chat from the list or <a class="classic" href="javascript:newChat();">start a new chat</a></p></div>
				</div>
				<div id="theChat" style="display:none;">
					<div style="height:22.5px; background-color:var(--content-bg); border-bottom: 1px solid var(--border); padding:8px 16px;"><h3 style="margin:0; display:inline-block;"><a class="classic" target="_blank" id="chatPersonUsername"></a></h3><div style="float:right;"><a class="classic" href="javascript:toggleEncrypt();" id="encryptionMarker" style="margin-right:8px; color:var(--verified);">&#x1f512;&#xfe0e;</a><h3 style="margin:0; display:inline-block;"><a class="classic" href="javascript:chatMenu();">&#8943;</a></h3></div></div>
					<div style="overflow-y:auto; overflow-x:hidden; height:calc(100vh - 137.5px);" id="messages"></div>
					<textarea oninput="saveMessage();" autocomplete="off" id="messageBox" class="chattxf" placeholder="Type a message"></textarea>
					<button id="sendButton" onclick="submitMessage()">&#x25b6;&#xfe0e;</button>
				</div>
			</div>
		</div>
		<div class="loader" id="loader"></div>
	</main>
</body>
</html>
<style>
	.selectedChatItem, .selectedChatItem:hover, .selectedChatItem:active {
		background-color: var(--link);
	}

	.selectedChatItem > * {
		color: var(--opposing);
	}
	
	.chattxf {
		border-top: 1px solid var(--border);
		border-style: solid none none none;
		height: 1.2em;
		background-color: var(--tb-back);
		color: var(--content);
		outline: none;
		width: calc(100% - 65px - 1.2em);
		display: block;
		resize: none;
		position: absolute;
		bottom: 0;
	}
	
	#sendButton {
		position:absolute;
		height: 49px;
		width: 49px;
		border-style: solid none none none;
		bottom: 0;
		right: 0;
		border-width: 1px;
		border-color: var(--border);
		padding: 0;
		font-size: 2em;
		line-height: 38px;
		outline: none;
		cursor: pointer;
		background-color: var(--link);
		color: var(--opposing);
	}
	
	.specialty .classic {
		color: var(--content);
	}
	
	.msgImage {
		max-width: 100%;
		margin-top: 8px;
		border-radius: 18.5px;
		vertical-align: top;
		height: 200px;
		min-width: 200px;
		object-fit: cover;
	}
	
	.nosides {
		border-left: none;
		border-right: none;
	}
	
	#toBottom {
		position: absolute;
		height: 48px;
		width: 48px;
		border: 1px solid var(--link);
		background-color: var(--content-bg);
		z-index: 1;
		bottom: 65px;
		border-radius: 100%;
		color: var(--link);
		font-size: 2em;
		outline: none;
		cursor: pointer;
		left: 16px;
		padding: 0px;
	}
	
	#toBottom:hover, #toBottom:active {
		background-color: var(--rollover);
	}
</style>