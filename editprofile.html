<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Edit Profile - ASTiW</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="themes/dark.css" id="themer">
	<script src="script.js"></script>
	<script>
		var okaytoleave = false;
		
		window.onbeforeunload = function() {
			if (!okaytoleave) {
				return true;
			}
		};
		
		function save() {
			if (!sessHasChanged()) {
				document.getElementById('bad').style.display = 'none';
				var name = document.getElementById('name').value;
				var email = document.getElementById('email').value;
				var birthday = document.getElementById('birthday').value;
				var bio = document.getElementById('bio').value;
				var showname = document.getElementById('showname').innerHTML != '';
				var showemail = document.getElementById('showemail').innerHTML != '';
				var showbirthday = document.getElementById('showbirthday').innerHTML != '';
				var showbio = document.getElementById('showbio').innerHTML != '';
				document.getElementById('save').style.display = 'none';
				document.getElementById('name').disabled = true;
				document.getElementById('email').disabled = true;
				document.getElementById('birthday').disabled = true;
				document.getElementById('bio').disabled = true;
				document.getElementById('showname').disabled = true;
				document.getElementById('showemail').disabled = true;
				document.getElementById('showbirthday').disabled = true;
				document.getElementById('showbio').disabled = true;
				var ldr = document.createElement('div');
				ldr.className = 'loader';
				ldr.id = 'loader';
				ldr.style.margin = '0 0 16px 0';
				document.getElementById('contain').appendChild(ldr);
				var sess = JSON.parse(localStorage.getItem('astiw_sesses'))[0];
				var jsonurl = 'https://api.stibarc.gq/updateprofile.sjs';
				var r = new XMLHttpRequest();
				r.addEventListener('load', function() {
					ans = r.responseText;
					if (ans == 'Updated\n') {
						okaytoleave = true;
						window.location.href = 'user.html?id=' + encodeURIComponent(getCurrentUser());
					} else {
						document.getElementById('name').disabled = false;
						document.getElementById('email').disabled = false;
						document.getElementById('birthday').disabled = false;
						document.getElementById('bio').disabled = false;
						document.getElementById('showname').disabled = false;
						document.getElementById('showemail').disabled = false;
						document.getElementById('showbirthday').disabled = false;
						document.getElementById('showbio').disabled = false;
						document.getElementById('bad').style.display = '';
						document.getElementById('contain').removeChild(document.getElementById('loader'));
						document.getElementById('save').style.display = 'initial';
					}
				});
				r.addEventListener('error', function() {alert('Could not connect to STiBaRC, please reload the page and try again')});
				r.open('post', jsonurl, true);
				r.send('sess=' + sess + '&name=' + encodeURIComponent(name) + '&email=' + encodeURIComponent(email) + '&birthday=' + encodeURIComponent(birthday) + '&bio=' + encodeURIComponent(bio).replace(/%0A/g, '%0D%0A') + (showname ? '&showname=true' : '') + (showemail ? '&showemail=true' : '') + (showbirthday ? '&showbday=true' : '') + (showbio ? '&showbio=true' : ''));
			} else {
				sayToReload();
			}
		};
		
		function load() {
			var sesses = localStorage.getItem('astiw_sesses');
			if (isSet(sesses) && JSON.parse(sesses).length > 0 && getCurrentUser() != 'Anon') {
				document.getElementById('name').addEventListener('keydown', function(e) {
					if (e.keyCode == 13 && e.ctrlKey) {
						e.preventDefault();
						save();
					}
				});
				document.getElementById('email').addEventListener('keydown', function(e) {
					if (e.keyCode == 13 && e.ctrlKey) {
						e.preventDefault();
						save();
					}
				});
				document.getElementById('birthday').addEventListener('keydown', function(e) {
					if (e.keyCode == 13 && e.ctrlKey) {
						e.preventDefault();
						save();
					}
				});
				document.getElementById('bio').addEventListener('keydown', function(e) {
					if (e.keyCode == 13 && e.ctrlKey) {
						e.preventDefault();
						save();
					}
				});
				var sess = JSON.parse(localStorage.getItem('astiw_sesses'))[0];
				var jsonurl = 'https://api.stibarc.gq/userinfo.sjs?sess=' + sess;
				var r = new XMLHttpRequest();
				r.addEventListener('load', function() {
					var obj = JSON.parse(r.responseText);
					document.getElementById('name').value = obj.name;
					document.getElementById('email').value = obj.email;
					document.getElementById('birthday').value = obj.birthday;
					document.getElementById('bio').value = obj.bio;
					if (obj.displayname) {toggleShow('name');}
					if (obj.displayemail) {toggleShow('email');}
					if (obj.displaybirthday) {toggleShow('birthday');}
					if (obj.displaybio) {toggleShow('bio');}
					document.getElementById('rm').removeChild(document.getElementById('loader2'));
					document.getElementById('eugh').style.display = '';
					document.getElementById('main').style.display = 'block';
				});
				r.addEventListener('error', function() {alert('Could not connect to STiBaRC, please reload the page and try again')});
				r.open('get', jsonurl, true);
				r.send();
			} else {
				okaytoleave = true;
				window.location.replace('login.html');
			}
		};
		
		function toggleShow(field) {
			var bttn = document.getElementById('show' + field);
			if (bttn.innerHTML == '') {
				bttn.innerHTML = '&#x2714;&#xFE0E;';
				bttn.style.backgroundColor = 'var(--probably-same-as-link)';
			} else {
				bttn.innerHTML = '';
				bttn.style.backgroundColor = 'var(--cb-off)';
			}
		};
	</script>
</head>
<body>
	<nav><a id="title" href="index.html">ASTiW</a><input type="search" id="search" class="txf" placeholder="Search"><a href="messenger.html" id="messengerButton" class="mi ib noanon">&#x1f4ac;&#xfe0e;</a><a href="newpost.html" class="mi ib">+</a><a href="settings.html" class="mi">&#8943;</a><a href="javascript:openUserMenu();" id="usermenu" class="mi ib rightmost"></a><a href="register.html" class="lb" id="register">REGISTER</a><a href="login.html" class="lb rightmost">LOG IN</a></nav>
	<div id="cssshade"></div>
	<div class="dbg" id="usermenubox">
		<div class="dialog">
			<a href="javascript:closeUserMenu();" class="closeButton">&times;</a>
			<h3 id="currentUserName"></h3>
			<div style="margin-top:16px;"><a class="othbut" id="userMenuProfButton" style="margin-right:8px;">View profile</a><a class="othbut noanon" href="editprofile.html">Edit profile</a></div>
			<p style="margin:8px 0;"><a class="classic noanon" href="changepassword.html">Change password</a></p>
			<p style="margin:8px 0;"><a class="classic noanon" href="mailto:herronjo110@gmail.com?subject=STiBaRC%20User%20Verification%20Request">Request user verification</a></p>
			<hr style="margin:20px 0;">
			<div id="accountSwitcher" style="display:none;">
				<h4 style="margin-top:20px;">Switch account</h4>
				<ul style="padding:0 0 0 20px;" id="accounts">
				</ul>
				<hr style="margin:20px 0;">
			</div>
			<div style="margin-top:16px;"><a class="othbut" href="login.html" style="margin-right:8px;">Add account</a><a class="othbut" href="javascript:logoutCurrentUser();" id="lobut">Log out</a></div>
			<p style="margin:8px 0;"><a class="classic" href="register.html">Register a new account</a></p>
		</div>
	</div>
	<main id="rm">
		<h3 id="eugh" style="display:none;">Edit profile</h3>
		<div class="stdc" style="display:none;" id="main">
			<p class="tfl">Name</p>
			<div style="display:block; margin-bottom:10px;"><input autocomplete="off" spellcheck="false" type="text" id="name" class="txf e" placeholder="Name" style="margin-bottom:6px;"><div style="display:inline-block; vertical-align:top;"><button id="showname" class="cb" onclick="toggleShow('name');" style="margin-bottom:6px;"></button><p class="whateverthisis">Make name public</p></div></div>
			<p class="tfl">Email</p>
			<div style="display:block; margin-bottom:10px;"><input autocomplete="off" spellcheck="false" type="text" id="email" class="txf e" placeholder="Email" style="margin-bottom:6px;"><div style="display:inline-block; vertical-align:top;"><button id="showemail" class="cb" onclick="toggleShow('email');" style="margin-bottom:6px;"></button><p class="whateverthisis">Make email public</p></div></div>
			<p class="tfl">Birthday</p>
			<div style="display:block; margin-bottom:10px;"><input autocomplete="off" spellcheck="false" type="text" id="birthday" class="txf e" placeholder="Birthday" style="margin-bottom:6px;"><div style="display:inline-block; vertical-align:top;"><button id="showbirthday" class="cb" onclick="toggleShow('birthday');" style="margin-bottom:6px;"></button><p class="whateverthisis">Make birthday public</p></div></div>
			<p class="tfl">Bio</p>
			<div style="display:block; margin-bottom:10px;"><textarea id="bio" class="txf e" placeholder="Bio" style="margin-bottom:6px; height:108px; width:calc(100% - 34px);"></textarea><div style="display:inline-block; vertical-align:top;"><button id="showbio" class="cb" onclick="toggleShow('bio');" style="margin-bottom:6px;"></button><p class="whateverthisis">Make bio public</p></div></div>
			<div id="contain"><button id="save" onclick="save();" class="libut" style="display:block; margin-bottom:16px;">SAVE</button></div>
			<p class="small" style="color:var(--red); display:none;" id="bad">Edit failed</p>
		</div>
		<div class="loader" id="loader2"></div>
	</main>
</body>
</html>